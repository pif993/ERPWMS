package http
import("net/http";"github.com/gin-gonic/gin";"github.com/google/uuid";"github.com/jackc/pgx/v5/pgxpool")
type AdminPortal struct{DB *pgxpool.Pool}
func(p AdminPortal)UsersPage(c *gin.Context){rows,err:=p.DB.Query(c,`SELECT id::text,email_hash,status,created_at::text FROM users ORDER BY created_at DESC LIMIT 100`);if err!=nil{c.String(500,err.Error());return};defer rows.Close();type U struct{ID string;EmailHash string;Status string;CreatedAt string};us:=[]U{};for rows.Next(){var id,eh,st,ca string;rows.Scan(&id,&eh,&st,&ca);us=append(us,U{id,eh,st,ca})};rs,err:=p.DB.Query(c,`SELECT id::text,name FROM roles ORDER BY name`);if err!=nil{c.String(500,err.Error());return};defer rs.Close();type R struct{ID string;Name string};rl:=[]R{};for rs.Next(){var i,n string;rs.Scan(&i,&n);rl=append(rl,R{i,n})};c.HTML(http.StatusOK,"pages/admin/users.html",gin.H{"Users":us,"Roles":rl})}
func(p AdminPortal)SetUserRole(c *gin.Context){uid:=c.PostForm("user_id");rid:=c.PostForm("role_id");u,eu:=uuid.Parse(uid);r,er:=uuid.Parse(rid);if eu!=nil||er!=nil{c.String(400,"bad uuid");return};p.DB.Exec(c,`DELETE FROM user_roles WHERE user_id=$1`,u);p.DB.Exec(c,`INSERT INTO user_roles(user_id,role_id) VALUES($1,$2) ON CONFLICT DO NOTHING`,u,r);c.Redirect(302,"/admin/users")}
